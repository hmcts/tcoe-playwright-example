#!groovy

properties([
  // Currently, we run this pipeline on the first monday of every month (for resources sake)
  // If you want to run this nightly, uncomment the below line
  // pipelineTriggers([cron('H 8 * * 1-5')]),
  pipelineTriggers([cron('H 8 1-7 * 1')]),
  disableConcurrentBuilds(),
  parameters([
    string(
      name: 'CITIZEN_FRONTEND_BASE_URL',
      defaultValue: 'https://privatelaw.aat.platform.hmcts.net/',
      description: 'The Citizen URL to test against'
    ),
    string(
      name: 'MANAGE_CASES_BASE_URL',
      defaultValue: 'https://manage-case.aat.platform.hmcts.net/cases',
      description: 'The Manage Cases URL to test against'
    ),
    string(
      name: 'FUNCTIONAL_TESTS_WORKERS',
      defaultValue: '4',
      description: 'Number of workers running functional tests'
    ),
    string(
      name: 'TAGS_TO_RUN',
      defaultValue: '',
      description: 'Optionally, run a single or multiple tags (comma separated e.g. @cui, @exui)'
    ),
    choice(
      name: 'BROWSER_TO_RUN',
      choices: ['chromium', 'chrome', 'firefox', 'webkit', 'edge', 'tabletchrome', 'tabletwebkit'],
      description: 'Choose what browsers will be run (only when a tag is specified)'
    ),
  ])
])

@Library("Infrastructure")

// Replace these with your own teams info
def type = "nodejs"
def product = "dtsse"
def component = "e2e-tests"
def channel = "#tcoe-builds"

static Map < String, Object > secret(String secretName, String envVariable) {
  [
    $class: 'AzureKeyVaultSecret',
    secretType: 'Secret',
    name: secretName,
    envVariable: envVariable
  ]
}

// Replace the key vault name with your own service
def secrets = [
  'prl-${env}': [
    secret('case-manager-swansea-username', 'CASEMANAGER_USERNAME'),
    secret('case-manager-swansea-password', 'CASEMANAGER_PASSWORD'),
    secret('judge-testuser-one', 'JUDGE_USERNAME'),
    secret('judge-testpassword', 'JUDGE_PASSWORD'),
    secret('prl-cos-idam-client-secret', 'IDAM_SECRET'),
    secret('idam-citizen-password', 'IDAM_CITIZEN_USER_PASSWORD'),
  ]
]

def buildPlaywrightCommand(tags, browser) {
  if (tags == null || tags.trim().isEmpty()) {
    return;
  }
  def tagList = tags.split(',').collect { it.trim() }

  def command = 'playwright test playwright-e2e/tests/'
    tagList.each { tag ->
    if (!tag.isEmpty()) {
      command += " --grep ${tag}"
    }
  }

  if (browser) {
    command += " --project=${browser}"
  }

  return command
}

def buildReportEnv(String suiteDir, boolean skipApiEndpoints = false) {
  def envVars = [
    'PLAYWRIGHT_REPORTERS=list,html,odhin,junit',
    "PLAYWRIGHT_HTML_OUTPUT=${suiteDir}/html-report",
    "PW_ODHIN_OUTPUT=${suiteDir}/odhin-report",
    "PW_ODHIN_TARGET=${suiteDir}/odhin-report",
    "PLAYWRIGHT_JUNIT_OUTPUT=${suiteDir}/playwright-junit.xml",
    'PW_ODHIN_LINK_COVERAGE=true'
  ]

  if (skipApiEndpoints) {
    envVars.add('PW_ODHIN_SKIP_API_ENDPOINTS=true')
  }

  return envVars
}

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)

def archiveCoverageReports(yarnBuilder) {
  // Best-effort: skips quietly if coverage or api specs are absent
  try {
    yarnBuilder.yarn('report:coverage')
    yarnBuilder.yarn('report:api-endpoints')
    archiveArtifacts allowEmptyArchive: true, artifacts: 'coverage/**'
  } catch (Error) {
    unstable(message: "Coverage & endpoint archival is unstable: " + Error.toString())
  }
}

withNightlyPipeline(type, product, component, 600) {
  loadVaultSecrets(secrets)
  env.CITIZEN_FRONTEND_BASE_URL = params.CITIZEN_FRONTEND_BASE_URL
  env.MANAGE_CASES_BASE_URL = params.MANAGE_CASES_BASE_URL
  env.FUNCTIONAL_TESTS_WORKERS = params.FUNCTIONAL_TESTS_WORKERS
  enableSlackNotifications(channel)

  afterAlways('DependencyCheckNightly') {
    stage('Delete nightly dev branch') {
      try {
        yarnBuilder.yarn('delete-nightly-dev-branch tcoe-playwright-example')
      } catch (Error) {
        unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
      }
    }
    stage('Set up playwright') {
      try {
        yarnBuilder.yarn('setup')
      } catch (Error) {
        unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
      }
    }
    if (!TAGS_TO_RUN.isEmpty()) {
      stage("${TAGS_TO_RUN} E2E Tests for ${params.BROWSER_TO_RUN}") {
        def safeTags = TAGS_TO_RUN.replaceAll(/[^A-Za-z0-9_.-]+/, "_")
        def reportDir = "functional-output/tests/playwright-e2e/tags-${safeTags}-${params.BROWSER_TO_RUN}"
        def reportEnv = buildReportEnv(reportDir, true)
        try {
          currentBuild.displayName = "${TAGS_TO_RUN} E2E Tests for ${params.BROWSER_TO_RUN}"
          if (params.BROWSER_TO_RUN == 'edge') yarnBuilder.yarn('setup:edge')
          withEnv(reportEnv) {
            yarnBuilder.yarn(buildPlaywrightCommand(TAGS_TO_RUN, params.BROWSER_TO_RUN))
          }
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          withEnv(reportEnv) {
            yarnBuilder.yarn('node ./scripts/copy-odhin-report.mjs')
          }
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/html-report",
            reportFiles: 'index.html',
            reportName: "${TAGS_TO_RUN} E2E Tests for ${params.BROWSER_TO_RUN} (HTML)"
          ])
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/odhin-report",
            reportFiles: 'playwright-odhin.html',
            reportName: "${TAGS_TO_RUN} E2E Tests for ${params.BROWSER_TO_RUN} (Odhin)"
          ])
          junit(testResults: "${reportDir}/playwright-junit.xml", allowEmptyResults: true)
          archiveArtifacts allowEmptyArchive: true, artifacts: "${reportDir}/**"
        }
      }
    } else {
      currentBuild.displayName = "All E2E Tests"
      stage('API Tests') {
        def reportDir = "functional-output/tests/api"
        def reportEnv = buildReportEnv(reportDir)
        try {
          withEnv(reportEnv) {
            yarnBuilder.yarn('test:api')
          }
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          withEnv(reportEnv) {
            yarnBuilder.yarn('node ./scripts/copy-odhin-report.mjs')
          }
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/html-report",
            reportFiles: 'index.html',
            reportName: 'API Tests (HTML)'
          ])
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/odhin-report",
            reportFiles: 'playwright-odhin.html',
            reportName: 'API Tests (Odhin)'
          ])
          junit(testResults: "${reportDir}/playwright-junit.xml", allowEmptyResults: true)
          archiveArtifacts allowEmptyArchive: true, artifacts: "${reportDir}/**"
        }
      }
      stage('Chrome E2E Tests') {
        def reportDir = "functional-output/tests/playwright-e2e/chrome"
        def reportEnv = buildReportEnv(reportDir, true)
        try {
          withEnv(reportEnv) {
            yarnBuilder.yarn('test:chrome')
          }
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          withEnv(reportEnv) {
            yarnBuilder.yarn('node ./scripts/copy-odhin-report.mjs')
          }
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/html-report",
            reportFiles: 'index.html',
            reportName: 'Chrome E2E Tests (HTML)'
          ])
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/odhin-report",
            reportFiles: 'playwright-odhin.html',
            reportName: 'Chrome E2E Tests (Odhin)'
          ])
          junit(testResults: "${reportDir}/playwright-junit.xml", allowEmptyResults: true)
          archiveArtifacts allowEmptyArchive: true, artifacts: "${reportDir}/**"
        }
      }
      stage('Firefox E2E Tests') {
        def reportDir = "functional-output/tests/playwright-e2e/firefox"
        def reportEnv = buildReportEnv(reportDir, true)
        try {
          withEnv(reportEnv) {
            yarnBuilder.yarn('test:firefox')
          }
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          withEnv(reportEnv) {
            yarnBuilder.yarn('node ./scripts/copy-odhin-report.mjs')
          }
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/html-report",
            reportFiles: 'index.html',
            reportName: 'Firefox E2E Tests (HTML)'
          ])
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/odhin-report",
            reportFiles: 'playwright-odhin.html',
            reportName: 'Firefox E2E Tests (Odhin)'
          ])
          junit(testResults: "${reportDir}/playwright-junit.xml", allowEmptyResults: true)
          archiveArtifacts allowEmptyArchive: true, artifacts: "${reportDir}/**"
        }
      }
      stage('Webkit E2E Tests') {
        def reportDir = "functional-output/tests/playwright-e2e/webkit"
        def reportEnv = buildReportEnv(reportDir, true)
        try {
          withEnv(reportEnv) {
            yarnBuilder.yarn('test:webkit')
          }
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          withEnv(reportEnv) {
            yarnBuilder.yarn('node ./scripts/copy-odhin-report.mjs')
          }
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/html-report",
            reportFiles: 'index.html',
            reportName: 'Webkit E2E Tests (HTML)'
          ])
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/odhin-report",
            reportFiles: 'playwright-odhin.html',
            reportName: 'Webkit E2E Tests (Odhin)'
          ])
          junit(testResults: "${reportDir}/playwright-junit.xml", allowEmptyResults: true)
          archiveArtifacts allowEmptyArchive: true, artifacts: "${reportDir}/**"
        }
      }
      stage('Edge E2E Tests') {
        def reportDir = "functional-output/tests/playwright-e2e/edge"
        def reportEnv = buildReportEnv(reportDir, true)
        try {
          yarnBuilder.yarn('setup:edge') // Use hermetic install for edge
          withEnv(reportEnv) {
            yarnBuilder.yarn('test:edge')
          }
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          withEnv(reportEnv) {
            yarnBuilder.yarn('node ./scripts/copy-odhin-report.mjs')
          }
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/html-report",
            reportFiles: 'index.html',
            reportName: 'Edge E2E Tests (HTML)'
          ])
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/odhin-report",
            reportFiles: 'playwright-odhin.html',
            reportName: 'Edge E2E Tests (Odhin)'
          ])
          junit(testResults: "${reportDir}/playwright-junit.xml", allowEmptyResults: true)
          archiveArtifacts allowEmptyArchive: true, artifacts: "${reportDir}/**"
        }
      }
      stage('Accessibility Tests') {
        def reportDir = "functional-output/tests/playwright-e2e/a11y"
        def reportEnv = buildReportEnv(reportDir, true)
        try {
          withEnv(reportEnv) {
            yarnBuilder.yarn('test:a11y')
          }
        } catch (Error) {
          unstable(message: "${STAGE_NAME} is unstable: " + Error.toString())
        } finally {
          withEnv(reportEnv) {
            yarnBuilder.yarn('node ./scripts/copy-odhin-report.mjs')
          }
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/html-report",
            reportFiles: 'index.html',
            reportName: 'Accessibility Tests (HTML)'
          ])
          publishHTML([
            allowMissing: true,
            alwaysLinkToLastBuild: true,
            keepAll: true,
            reportDir: "${reportDir}/odhin-report",
            reportFiles: 'playwright-odhin.html',
            reportName: 'Accessibility Tests (Odhin)'
          ])
          junit(testResults: "${reportDir}/playwright-junit.xml", allowEmptyResults: true)
          archiveArtifacts allowEmptyArchive: true, artifacts: "${reportDir}/**"
        }
      }
      stage('Generate coverage & endpoint reports') {
        archiveCoverageReports(yarnBuilder)
      }
    }
  }
}
